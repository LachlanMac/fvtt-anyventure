{{!-- Character Tab Content --}}
<div class="character-page">
  {{!-- Character Utilities --}}
  {{#unless (eq actor.type "npc")}}
  <div class="character-utilities" style="text-align: center; margin-bottom: 15px;">
    <button type="button" class="recalculate-character" title="Recalculate all character stats from modules">
      <i class="fas fa-calculator"></i> Recalculate Stats
    </button>
  </div>
  {{/unless}}

  {{!-- Character Essentials Section --}}
  {{#unless (eq actor.type "npc")}}
  <div class="character-essentials">
    {{!-- Ancestry Section --}}
    {{#if ancestry}}
    <div class="character-essential-section ancestry-section">
      <div class="essential-icon">
        <img src="{{ancestry.img}}" alt="{{ancestry.name}}" />
      </div>
      <div class="essential-content">
        <h4 class="essential-title">Ancestry: {{ancestry.name}}</h4>
      </div>
      <div class="essential-controls">
        <a class="item-control item-edit" data-item-id="{{ancestry._id}}" title="Edit"><i class="fas fa-edit"></i></a>
        <a class="item-control item-delete" data-item-id="{{ancestry._id}}" title="Delete"><i class="fas fa-trash"></i></a>
      </div>
    </div>
    {{else}}
    <div class="character-essential-empty ancestry-empty">
      <div class="essential-drop-zone" data-essential-type="ancestry">
        <i class="fas fa-upload"></i>
        <span>Drag and Drop Ancestry Here</span>
      </div>
    </div>
    {{/if}}

    {{!-- Culture Section --}}
    {{#if culture}}
    <div class="character-essential-section culture-section">
      <div class="essential-icon">
        <img src="{{culture.img}}" alt="{{culture.name}}" />
      </div>
      <div class="essential-content">
        <h4 class="essential-title">Culture: {{culture.name}}</h4>
      </div>
      <div class="essential-controls">
        <a class="item-control item-edit" data-item-id="{{culture._id}}" title="Edit"><i class="fas fa-edit"></i></a>
        <a class="item-control item-delete" data-item-id="{{culture._id}}" title="Delete"><i class="fas fa-trash"></i></a>
      </div>
    </div>
    {{else}}
    <div class="character-essential-empty culture-empty">
      <div class="essential-drop-zone" data-essential-type="culture">
        <i class="fas fa-upload"></i>
        <span>Drag and Drop Culture Here</span>
      </div>
    </div>
    {{/if}}

    {{!-- Personality Section --}}
    {{#if personality}}
    <div class="character-essential-section personality-section">
      <div class="essential-icon">
        <img src="{{personality.img}}" alt="{{personality.name}}" />
      </div>
      <div class="essential-content">
        <h4 class="essential-title">Personality: {{personality.name}}</h4>
      </div>
      <div class="essential-controls">
        <a class="item-control item-edit" data-item-id="{{personality._id}}" title="Edit"><i class="fas fa-edit"></i></a>
        <a class="item-control item-delete" data-item-id="{{personality._id}}" title="Delete"><i class="fas fa-trash"></i></a>
      </div>
    </div>
    {{else}}
    <div class="character-essential-empty personality-empty">
      <div class="essential-drop-zone" data-essential-type="personality">
        <i class="fas fa-upload"></i>
        <span>Drag and Drop Personality Here</span>
      </div>
    </div>
    {{/if}}

    {{!-- Trait Section --}}
    {{#if trait}}
    <div class="character-essential-section trait-section">
      <div class="essential-icon">
        <img src="{{trait.img}}" alt="{{trait.name}}" />
      </div>
      <div class="essential-content">
        <h4 class="essential-title">Trait: {{trait.name}}</h4>
      </div>
      <div class="essential-controls">
        <a class="item-control item-edit" data-item-id="{{trait._id}}" title="Edit"><i class="fas fa-edit"></i></a>
        <a class="item-control item-delete" data-item-id="{{trait._id}}" title="Delete"><i class="fas fa-trash"></i></a>
      </div>
    </div>
    {{else}}
    <div class="character-essential-empty trait-empty">
      <div class="essential-drop-zone" data-essential-type="trait">
        <i class="fas fa-upload"></i>
        <span>Drag and Drop Trait Here</span>
      </div>
    </div>
    {{/if}}

    {{!-- Training Items Section --}}
    {{#each trainingItems as |training|}}
    <div class="character-essential-section training-section">
      <div class="essential-icon">
        <img src="{{training.img}}" alt="{{training.name}}" />
      </div>
      <div class="essential-content">
        <h4 class="essential-title">{{training.name}}</h4>
      </div>
      <div class="essential-controls">
        <a class="item-control item-edit" data-item-id="{{training._id}}" title="Edit"><i class="fas fa-edit"></i></a>
        <a class="item-control item-delete" data-item-id="{{training._id}}" title="Delete"><i class="fas fa-trash"></i></a>
      </div>
    </div>
    {{/each}}
  </div>

  {{/unless}}

  {{!-- Traits & Modules Section --}}
  <div class="traits-modules-section">
    {{!-- Tab Navigation --}}
    <nav class="sheet-tabs tabs" data-group="character-secondary">
      <a class="item active" data-tab="traits">Traits</a>
      {{#unless (eq actor.type "npc")}}<a class="item" data-tab="modules">Modules</a>{{/unless}}
      <a class="item" data-tab="conditions">Conditions</a>
      <a class="item" data-tab="injuries">Injuries</a>
    </nav>

    {{!-- Traits Tab --}}
    <div class="tab traits active" data-group="character-secondary" data-tab="traits">
{{#if (eq actor.type "npc")}}
  <div class="character-essentials" style="margin-bottom: 10px;">
    <div class="essential-controls" style="justify-content:flex-end;">
      <a class="item-control item-create" title="Add Trait" data-type="trait"><i class="fas fa-plus"></i> Add Trait</a>
    </div>
  </div>
  <div class="trait-list">
    {{#each items as |item|}}
      {{#if (eq item.type 'trait')}}
      <div class="trait-item">
        <div class="trait-content">
          <h5 class="trait-name">{{item.name}}</h5>
          {{#if item.system.description}}<p class="trait-description">{{item.system.description}}</p>{{/if}}
        </div>
        <div class="essential-controls">
          <a class="item-control item-edit" data-item-id="{{item._id}}" title="Edit"><i class="fas fa-edit"></i></a>
          <a class="item-control item-delete" data-item-id="{{item._id}}" title="Delete"><i class="fas fa-trash"></i></a>
        </div>
      </div>
      {{/if}}
    {{/each}}
  </div>
{{else}}
      {{!-- Ancestry Traits --}}
      <div class="trait-category">
        <h4 class="trait-category-header">
          <i class="fas fa-dna"></i>
          Ancestry Traits
        </h4>
        <div class="trait-list">
          {{#each ancestryTraits as |trait|}}
          <div class="trait-item">
            <div class="trait-content">
              <h5 class="trait-name">{{trait.name}}</h5>
              <p class="trait-description">{{trait.description}}</p>
            </div>
          </div>
          {{else}}
          <div class="trait-empty">No ancestry traits</div>
          {{/each}}
        </div>
      </div>

      {{!-- Cultural Traits --}}
      <div class="trait-category">
        <h4 class="trait-category-header">
          <i class="fas fa-globe"></i>
          Cultural Traits
        </h4>
        <div class="trait-list">
          {{#each culturalTraits as |trait|}}
          <div class="trait-item">
            <div class="trait-content">
              <h5 class="trait-name">{{trait.name}}</h5>
              <p class="trait-description">{{trait.description}}</p>
            </div>
          </div>
          {{else}}
          <div class="trait-empty">No cultural traits</div>
          {{/each}}
        </div>
      </div>

      {{!-- General Traits --}}
      <div class="trait-category">
        <h4 class="trait-category-header">
          <i class="fas fa-cog"></i>
          General Traits
        </h4>
        <div class="trait-list">
          {{#each generalTraits as |trait|}}
          <div class="trait-item">
            <div class="trait-content">
              <h5 class="trait-name">{{trait.name}}</h5>
              <p class="trait-description">{{trait.description}}</p>
            </div>
          </div>
          {{else}}
          <div class="trait-empty">No general traits</div>
          {{/each}}
        </div>
      </div>

      {{!-- Crafting Traits --}}
      <div class="trait-category">
        <h4 class="trait-category-header">
          <i class="fas fa-hammer"></i>
          Crafting Traits
        </h4>
        <div class="trait-list">
          {{#each craftingTraits as |trait|}}
          <div class="trait-item">
            <div class="trait-content">
              <h5 class="trait-name">{{trait.name}}</h5>
              <p class="trait-description">{{trait.description}}</p>
            </div>
          </div>
          {{else}}
          <div class="trait-empty">No crafting traits</div>
          {{/each}}
        </div>
      </div>

      {{!-- Personality Traits --}}
      <div class="trait-category">
        <h4 class="trait-category-header">
          <i class="fas fa-user"></i>
          Personality Traits
        </h4>
        <div class="trait-list">
          {{#each personalityTraits as |trait|}}
          <div class="trait-item">
            <div class="trait-content">
              <h5 class="trait-name">{{trait.name}}</h5>
              <p class="trait-description">{{trait.description}}</p>
            </div>
          </div>
          {{else}}
          <div class="trait-empty">No personality traits</div>
          {{/each}}
        </div>
      </div>
    </div>

    {{/if}}
{{!-- Modules Tab --}}
    <div class="tab modules" data-group="character-secondary" data-tab="modules">
      {{!-- Module Points --}}
      <div class="module-points">
        {{#if system.modulePoints.total}}
          {{!-- New structure: { total: X, spent: Y } --}}
          <label>Module Points:
            <input type="number" name="system.modulePoints.spent" value="{{system.modulePoints.spent}}" min="0" style="width: 50px; margin-left: 5px;" />
            /
            <input type="number" name="system.modulePoints.total" value="{{system.modulePoints.total}}" min="0" style="width: 50px; margin-left: 2px;" />
          </label>
          <span style="margin-left: 10px; color: #666;">({{availableModulePoints}} available)</span>
        {{else}}
          {{!-- Legacy structure: just a number --}}
          <label>Available Module Points:
            <input type="number" name="system.modulePoints" value="{{system.modulePoints}}" min="0" style="width: 60px; margin-left: 5px;" />
          </label>
        {{/if}}
      </div>

      {{!-- Modules List --}}
      <ol class="items-list">
        {{#each modules as |item id|}}
        <li class="item flexrow" data-item-id="{{item._id}}">
          <div class="item-name">
            <div class="item-image">
              <a class="rollable" data-roll-type="item"><img src="{{item.img}}" title="{{item.name}}" width="24" height="24"/></a>
            </div>
            <h4>{{item.name}}</h4>
          </div>
          <div class="item-type">{{item.system.moduleType}}</div>
          <div class="item-controls">
            <a class="item-control item-edit" title="Edit Item"><i class="fas fa-edit"></i></a>
            <a class="item-control item-delete" title="Delete Item"><i class="fas fa-trash"></i></a>
          </div>
        </li>
        {{/each}}
      </ol>
    </div>

    {{!-- Conditions Tab --}}
    <div class="tab conditions" data-group="character-secondary" data-tab="conditions">
      <div class="moves-section">
        <div class="section-header">
          <h3>Active Conditions</h3>
        </div>
        <div class="moves-list">
          {{#each conditionCards as |condition|}}
          <div class="ability-item condition-item" data-condition-id="{{condition.id}}" data-status-id="{{condition.statusId}}">
            <div class="ability-icon">
              <img src="{{condition.icon}}" alt="{{condition.name}}" />
            </div>
            <div class="ability-content">
              <div class="ability-header">
                <h4 class="ability-name">{{condition.name}}</h4>
                {{#if condition.checkType}}
                <div class="condition-check-info">
                  <span class="check-label">RC: {{capitalize condition.checkType}} {{condition.currentCheck}}</span>
                </div>
                {{/if}}
                {{#if condition.turnsActive}}
                <div class="condition-turns">
                  <span class="turns-label">Turns Active: {{condition.turnsActive}}</span>
                </div>
                {{/if}}
              </div>
              {{#if condition.description}}
              <p class="ability-description">{{condition.description}}</p>
              {{/if}}
            </div>
            <div class="ability-controls">
              {{#if condition.canRoll}}
              <a class="condition-roll-btn"
                 data-check-type="{{condition.checkType}}"
                 data-dc="{{condition.currentCheck}}"
                 data-condition-id="{{condition.id}}"
                 title="Roll {{capitalize condition.checkType}} Check">
                <i class="fas fa-dice-d20"></i>
              </a>
              {{/if}}
              <a class="item-control item-edit condition-edit-btn"
                 data-condition-id="{{condition.id}}"
                 title="Edit Condition">
                <i class="fas fa-edit"></i>
              </a>
              <a class="item-control item-delete condition-remove-btn"
                 data-condition-id="{{condition.id}}"
                 title="Remove Condition">
                <i class="fas fa-trash"></i>
              </a>
            </div>
          </div>
          {{else}}
          <div class="empty-message">
            <i class="fas fa-heart"></i>
            <p>No active conditions</p>
            <p class="empty-hint">Conditions will appear here when applied to this character</p>
          </div>
          {{/each}}
        </div>
      </div>
    </div>

    {{!-- Injuries Tab --}}
    <div class="tab injuries" data-group="character-secondary" data-tab="injuries">
      {{!-- Combined Pain/Stress Modifier Card --}}
      <div class="character-essential-section modifier-card">
        <div class="essential-content" style="flex: 1;">
          <div class="modifier-row-container">
            <div class="modifier-col pain-col">
              <label for="system.resources.pain.modifier" style="font-weight: bold;">Pain Modifier:</label>
              <input type="number" name="system.resources.pain.modifier" value="{{system.resources.pain.modifier}}" data-dtype="Number" style="width: 80px;"/>
            </div>
            <div class="modifier-col stress-col">
              <label for="system.resources.stress.modifier" style="font-weight: bold;">Stress Modifier:</label>
              <input type="number" name="system.resources.stress.modifier" value="{{system.resources.stress.modifier}}" data-dtype="Number" style="width: 80px;"/>
            </div>
          </div>
        </div>
      </div>

      {{!-- Injuries List --}}
      <div class="moves-section">
        <div class="section-header">
          <h3>Active Injuries</h3>
        </div>
        <div class="moves-list">
          {{#each injuryCards as |injury|}}
          <div class="ability-item injury-item" data-injury-id="{{injury.id}}">
            <div class="ability-icon">
              <img src="{{injury.icon}}" alt="{{injury.name}}" />
            </div>
            <div class="ability-content">
              <div class="ability-header">
                <h4 class="ability-name">{{injury.name}}</h4>
                {{#if injury.canRoll}}
                <div class="injury-check-info">
                  <span class="check-label">RC: {{capitalize injury.recoverySkill}} {{injury.recoveryCheck}}</span>
                </div>
                {{/if}}
                <div class="injury-effects">
                  {{#if (gt injury.pain 0)}}
                  <span class="injury-pain">Pain: +{{injury.pain}}</span>
                  {{/if}}
                  {{#if (gt injury.stress 0)}}
                  <span class="injury-stress">Stress: +{{injury.stress}}</span>
                  {{/if}}
                </div>
              </div>
            </div>
            <div class="ability-controls">
              {{#if injury.canRoll}}
              <a class="injury-roll-btn"
                 data-recovery-skill="{{injury.recoverySkill}}"
                 data-dc="{{injury.recoveryCheck}}"
                 data-injury-id="{{injury.id}}"
                 title="Roll {{capitalize injury.recoverySkill}} Check">
                <i class="fas fa-dice-d20"></i>
              </a>
              {{/if}}
              <a class="item-control item-edit injury-edit-btn"
                 data-injury-id="{{injury.id}}"
                 title="Edit Injury">
                <i class="fas fa-edit"></i>
              </a>
              <a class="item-control item-delete injury-remove-btn"
                 data-injury-id="{{injury.id}}"
                 title="Remove Injury">
                <i class="fas fa-trash"></i>
              </a>
            </div>
          </div>
          {{else}}
          <div class="empty-message">
            <i class="fas fa-band-aid"></i>
            <p>No active injuries</p>
            <p class="empty-hint">Injuries will appear here when applied to this character</p>
          </div>
          {{/each}}
        </div>
      </div>
    </div>
  </div>
</div>