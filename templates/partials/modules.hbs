{{!-- Character Tab Content --}}
<div class="character-page">
  {{!-- Character Utilities --}}
  <div class="character-utilities" style="text-align: center; margin-bottom: 15px;">
    <button type="button" class="recalculate-character" title="Recalculate all character stats from modules">
      <i class="fas fa-calculator"></i> Recalculate Stats
    </button>
  </div>

  {{!-- Character Essentials Section --}}
  <div class="character-essentials">
    {{!-- Ancestry Section --}}
    {{#if ancestry}}
    <div class="character-essential-section ancestry-section">
      <div class="essential-icon">
        <img src="{{ancestry.img}}" alt="{{ancestry.name}}" />
      </div>
      <div class="essential-content">
        <h4 class="essential-title">Ancestry: {{ancestry.name}}</h4>
      </div>
      <div class="essential-controls">
        <a class="item-control item-edit" data-item-id="{{ancestry._id}}" title="Edit"><i class="fas fa-edit"></i></a>
        <a class="item-control item-delete" data-item-id="{{ancestry._id}}" title="Delete"><i class="fas fa-trash"></i></a>
      </div>
    </div>
    {{else}}
    <div class="character-essential-empty ancestry-empty">
      <div class="essential-drop-zone" data-essential-type="ancestry">
        <i class="fas fa-upload"></i>
        <span>Drag and Drop Ancestry Here</span>
      </div>
    </div>
    {{/if}}

    {{!-- Culture Section --}}
    {{#if culture}}
    <div class="character-essential-section culture-section">
      <div class="essential-icon">
        <img src="{{culture.img}}" alt="{{culture.name}}" />
      </div>
      <div class="essential-content">
        <h4 class="essential-title">Culture: {{culture.name}}</h4>
      </div>
      <div class="essential-controls">
        <a class="item-control item-edit" data-item-id="{{culture._id}}" title="Edit"><i class="fas fa-edit"></i></a>
        <a class="item-control item-delete" data-item-id="{{culture._id}}" title="Delete"><i class="fas fa-trash"></i></a>
      </div>
    </div>
    {{else}}
    <div class="character-essential-empty culture-empty">
      <div class="essential-drop-zone" data-essential-type="culture">
        <i class="fas fa-upload"></i>
        <span>Drag and Drop Culture Here</span>
      </div>
    </div>
    {{/if}}

    {{!-- Personality Section --}}
    {{#if personality}}
    <div class="character-essential-section personality-section">
      <div class="essential-icon">
        <img src="{{personality.img}}" alt="{{personality.name}}" />
      </div>
      <div class="essential-content">
        <h4 class="essential-title">Personality: {{personality.name}}</h4>
      </div>
      <div class="essential-controls">
        <a class="item-control item-edit" data-item-id="{{personality._id}}" title="Edit"><i class="fas fa-edit"></i></a>
        <a class="item-control item-delete" data-item-id="{{personality._id}}" title="Delete"><i class="fas fa-trash"></i></a>
      </div>
    </div>
    {{else}}
    <div class="character-essential-empty personality-empty">
      <div class="essential-drop-zone" data-essential-type="personality">
        <i class="fas fa-upload"></i>
        <span>Drag and Drop Personality Here</span>
      </div>
    </div>
    {{/if}}

    {{!-- Trait Section --}}
    {{#if trait}}
    <div class="character-essential-section trait-section">
      <div class="essential-icon">
        <img src="{{trait.img}}" alt="{{trait.name}}" />
      </div>
      <div class="essential-content">
        <h4 class="essential-title">Trait: {{trait.name}}</h4>
      </div>
      <div class="essential-controls">
        <a class="item-control item-edit" data-item-id="{{trait._id}}" title="Edit"><i class="fas fa-edit"></i></a>
        <a class="item-control item-delete" data-item-id="{{trait._id}}" title="Delete"><i class="fas fa-trash"></i></a>
      </div>
    </div>
    {{else}}
    <div class="character-essential-empty trait-empty">
      <div class="essential-drop-zone" data-essential-type="trait">
        <i class="fas fa-upload"></i>
        <span>Drag and Drop Trait Here</span>
      </div>
    </div>
    {{/if}}
  </div>

  {{!-- Traits & Modules Section --}}
  <div class="traits-modules-section">
    {{!-- Tab Navigation --}}
    <nav class="sheet-tabs tabs" data-group="character-secondary">
      <a class="item active" data-tab="traits">Traits</a>
      <a class="item" data-tab="modules">Modules</a>
    </nav>

    {{!-- Traits Tab --}}
    <div class="tab traits active" data-group="character-secondary" data-tab="traits">
      {{!-- Ancestry Traits --}}
      <div class="trait-category">
        <h4 class="trait-category-header">
          <i class="fas fa-dna"></i>
          Ancestry Traits
        </h4>
        <div class="trait-list">
          {{#each ancestryTraits as |trait|}}
          <div class="trait-item">
            <div class="trait-content">
              <h5 class="trait-name">{{trait.name}}</h5>
              <p class="trait-description">{{trait.description}}</p>
            </div>
          </div>
          {{else}}
          <div class="trait-empty">No ancestry traits</div>
          {{/each}}
        </div>
      </div>

      {{!-- Cultural Traits --}}
      <div class="trait-category">
        <h4 class="trait-category-header">
          <i class="fas fa-globe"></i>
          Cultural Traits
        </h4>
        <div class="trait-list">
          {{#each culturalTraits as |trait|}}
          <div class="trait-item">
            <div class="trait-content">
              <h5 class="trait-name">{{trait.name}}</h5>
              <p class="trait-description">{{trait.description}}</p>
            </div>
          </div>
          {{else}}
          <div class="trait-empty">No cultural traits</div>
          {{/each}}
        </div>
      </div>

      {{!-- General Traits --}}
      <div class="trait-category">
        <h4 class="trait-category-header">
          <i class="fas fa-cog"></i>
          General Traits
        </h4>
        <div class="trait-list">
          {{#each generalTraits as |trait|}}
          <div class="trait-item">
            <div class="trait-content">
              <h5 class="trait-name">{{trait.name}}</h5>
              <p class="trait-description">{{trait.description}}</p>
            </div>
          </div>
          {{else}}
          <div class="trait-empty">No general traits</div>
          {{/each}}
        </div>
      </div>

      {{!-- Crafting Traits --}}
      <div class="trait-category">
        <h4 class="trait-category-header">
          <i class="fas fa-hammer"></i>
          Crafting Traits
        </h4>
        <div class="trait-list">
          {{#each craftingTraits as |trait|}}
          <div class="trait-item">
            <div class="trait-content">
              <h5 class="trait-name">{{trait.name}}</h5>
              <p class="trait-description">{{trait.description}}</p>
            </div>
          </div>
          {{else}}
          <div class="trait-empty">No crafting traits</div>
          {{/each}}
        </div>
      </div>

      {{!-- Personality Traits --}}
      <div class="trait-category">
        <h4 class="trait-category-header">
          <i class="fas fa-user"></i>
          Personality Traits
        </h4>
        <div class="trait-list">
          {{#each personalityTraits as |trait|}}
          <div class="trait-item">
            <div class="trait-content">
              <h5 class="trait-name">{{trait.name}}</h5>
              <p class="trait-description">{{trait.description}}</p>
            </div>
          </div>
          {{else}}
          <div class="trait-empty">No personality traits</div>
          {{/each}}
        </div>
      </div>
    </div>

    {{!-- Modules Tab --}}
    <div class="tab modules" data-group="character-secondary" data-tab="modules">
      {{!-- Module Points --}}
      <div class="module-points">
        {{#if system.modulePoints.total}}
          {{!-- New structure: { total: X, spent: Y } --}}
          <label>Module Points:
            <input type="number" name="system.modulePoints.spent" value="{{system.modulePoints.spent}}" min="0" style="width: 50px; margin-left: 5px;" />
            /
            <input type="number" name="system.modulePoints.total" value="{{system.modulePoints.total}}" min="0" style="width: 50px; margin-left: 2px;" />
          </label>
          <span style="margin-left: 10px; color: #666;">({{availableModulePoints}} available)</span>
        {{else}}
          {{!-- Legacy structure: just a number --}}
          <label>Available Module Points:
            <input type="number" name="system.modulePoints" value="{{system.modulePoints}}" min="0" style="width: 60px; margin-left: 5px;" />
          </label>
        {{/if}}
      </div>

      {{!-- Modules List --}}
      <ol class="items-list">
        {{#each modules as |item id|}}
        <li class="item flexrow" data-item-id="{{item._id}}">
          <div class="item-name">
            <div class="item-image">
              <a class="rollable" data-roll-type="item"><img src="{{item.img}}" title="{{item.name}}" width="24" height="24"/></a>
            </div>
            <h4>{{item.name}}</h4>
          </div>
          <div class="item-type">{{item.system.moduleType}}</div>
          <div class="item-controls">
            <a class="item-control item-edit" title="Edit Item"><i class="fas fa-edit"></i></a>
            <a class="item-control item-delete" title="Delete Item"><i class="fas fa-trash"></i></a>
          </div>
        </li>
        {{/each}}
      </ol>
    </div>
  </div>
</div>